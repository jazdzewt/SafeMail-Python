<!DOCTYPE html>
<html>

<head>
    <title>Wiadomość</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
    <div class="container">
        <h1>Wiadomość od: {{ sender_name }}</h1>
        <p><a href="{{ url_for('dashboard') }}">Powrót do panelu</a></p>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="flash flash-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="message-meta">
            <p><strong>Temat:</strong> {{ msg.topic }}</p>
            <p><strong>Data:</strong> {{ msg.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </div>

        <div class="signature-section">
            <form action="{{ url_for('verify_signature', message_id=msg.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn-verify">
                    Zweryfikuj podpis cyfrowy
                </button>
            </form>

            <form action="{{ url_for('delete_message', message_id=msg.id) }}" method="POST" class="message-delete-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn-delete">
                    Usuń wiadomość
                </button>
            </form>
        </div>

        <hr>

        {% if decrypted_body %}
        <div class="message-body">
            <h3>Treść wiadomości:</h3>
            <pre class="message-content">{{ decrypted_body }}</pre>
        </div>

        {% if msg.attachments %}
        <div class="attachment-section">
            <h3>Załączniki:</h3>
            <ul>
                {% for att in msg.attachments %}
                <li class="attachment-item">
                    Plik: <strong>{{ att.filename }}</strong>
                    <form action="{{ url_for('download_attachment', attachment_id=att.id) }}" method="POST"
                        class="attachment-download-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="password" name="password" placeholder="Hasło" required
                            class="password-input-small">
                        <button type="submit" class="btn-small">Pobierz</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% else %}
        <div class="decrypt-form">
            <h3>Wiadomość jest zaszyfrowana.</h3>
            <form method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <label for="password">Podaj swoje hasło do konta:</label>
                <br>
                <input type="password" name="password" required>
                <button type="submit">Odszyfrowuj</button>
            </form>
        </div>
        {% endif %}
    </div>
</body>

</html>